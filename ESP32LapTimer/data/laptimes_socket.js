var e=0,t=null,n=8,l=0,i=4,a=[],o=[[]],r=1e3,s=0,c=!0,u=0;const d=2;function m(e){e.style.outline="1px solid orange"}function f(e){e.style.outline="1px solid green"}function v(e,t){return document.getElementById("lap_table_"+e).rows[t+1]}function h(e,t,n){return v(e,t).cells[n+d]}function p(e,t,n){return parseFloat(1*h(e,t,n).innerText)}function g(e,t){var n=v(e,t);return n.cells[n.cells.length-4]}function _(e,t){return parseFloat(1*g(e,t).innerText)}function b(e,t){var n=v(e,t);return n.cells[n.cells.length-2]}function x(e,t){var n=v(e,t);return n.cells[n.cells.length-1]}function I(e,t,n){var l=v(e,t);l.cells[l.cells.length-3].innerText=n}function y(e,t,a,o){if(!(a>=i)){var r=function(e,t){return parseFloat(x(e,t).innerText)}(e,t),s=0;if(o/=1e3,0!=l||0!=a){if(r=Math.min(r,o),0==p(e,t,a))!function(e,t,n){var l=new SpeechSynthesisUtterance;const i=document.getElementById("voices");l.lang="en",l.text=`${e} lap ${t} is ${n} seconds`,console.log(l.voice),l.voice=speechSynthesis.getVoices().filter((function(e){return e.name===i.value}))[0],speechSynthesis.speak(l)}(function(e,t){return v(e,t).cells[1].lastChild.value}(e,t),a+l,o.toFixed(2)),function(e,t,n){g(e,t).innerText=n}(e,t,(_(e,t)+o).toFixed(3)),function(e){for(var t=[],l=0;l<n;++l){var i=_(e,l);i>0&&(t[t.length]={num:l,time:i})}for(t.sort((function(e,t){return e.time-t.time})),l=0;l<t.length;++l){I(e,t[l].num,l+1)}}(e);if(r.toFixed(3)==o.toFixed(3)){for(var c=h(e,t,a),u=0;u<i;++u)h(e,t,u).classList.remove("best_lap");c.classList.add("best_lap")}}!function(e,t,n,l){v(e,t).cells[n+d].innerText=l}(e,t,a,o);s=0;for(u=0==l;u<i;++u){var m=p(e,t,u);if(0==m||isNaN(m))break;s+=m}(function(e,t,n){b(e,t).innerText=n})(e,t,(s/=u-(0==l)).toFixed(3)),function(e,t,n){x(e,t).innerText=n}(e,t,r.toFixed(3))}}function E(t){var n="E"==t[0];n&&(t=t.substr(1));var l=parseInt(t[1]),i=t[2];if(n)switch(i){case"R":e=parseInt(t.substr(3),16);break;case"y":var r=parseInt(t.substr(3,8),16),c=parseInt(t.substr(11,4),16);null==o[l]&&(o[l]=[]),o[l].push({time:r,rssi:c}),s=Math.max(s,r)}else switch(i){case"L":var u=parseInt(t.substr(3,2),16),d=parseInt(t.substr(5),16);y(e,l,u,d);break;case"A":a[l]="1"==t[3];var m=v(e,l).cells[0].lastChild;f(m),m.checked=a[l];break;case"R":document.getElementById("race_mode").innerHTML=parseInt(t[3])?"Racing":"Finished"}}function C(e){for(var t=e.data.split("\n"),n=0;n<t.length;++n)E(t[n])}function k(e,t){var l=[];null==e&&(e=0);for(var i=0;i<n;++i)if(a[i]&&null!=o[i]){var r=l.length;l[r]={name:"Pilot"+i,data:[]};for(var s=o[i].length-1;s>=0;--s){var c=o[i][s].rssi,u=o[i][s].time;if(null==t&&(t=u),u<e)break;u>t||l[r].data.push({x:u,y:c})}l[r].data.reverse()}return l}!function e(n){(t=new WebSocket(n)).onmessage=C,t.onclose=function(){setTimeout((function(){e(n)}),1e3)},t.onopen=function(){t.send("ER*a\n"),t.send("R*a\n"),t.send("ES*y0010\n")}}("ws://192.168.4.1/ws"),document.getElementById("start_race_button").onclick=function(){e+=1,i=parseInt(document.getElementById("max_laps").value),function(e,i){if(console.log("Building table with race_num "+e),null==(o=document.getElementById("lap_table_"+e))){var o,r;for((o=document.getElementById("lap_table_default").cloneNode(!0)).id="lap_table_"+e,r=i;0!=r;r--){(s=o.rows[0].insertCell(d)).outerHTML='<th align="center">Lap '+(r-(0==l))+"</th>"}for(r=0;r<n;r++){var s,c=o.insertRow(-1);(s=c.insertCell(-1)).innerHTML='<input id="pilot_active_box_'+r+'" value='+r+' type="checkbox"></input>',s.firstChild.onclick=function(){m(this),a[parseInt(this.value)]=void 0,t.send(`R${this.value}A${this.checked?1:0}\n`)},s.firstChild.checked=a[r],f(s.firstChild),null==a[r]&&m(s.firstChild),s=c.insertCell(-1);var u=localStorage.getItem("pilot_name_"+r);null==u&&(u="Pilot "+(r+1)),s.innerHTML='<input id="pilot_name_'+r+'" type="text" name="pilot" value="'+u+'" oninput=update_default_pilot_name('+r+")>";for(var v=0;v<i;++v)c.insertCell(-1);c.insertCell(-1),c.insertCell(-1),c.insertCell(-1),c.insertCell(-1).innerText="99999"}var h=document.getElementById("table_container"),p=document.createElement("div");p.setAttribute("class","tabcontent"),p.id="round_tab_content_"+e,h.appendChild(p),p.appendChild(o);var g=document.getElementById("round_buttons");console.log(g),g.innerHTML+="<button class='tablinks' onclick='openRound(event,"+e+")'>Round "+e+"</button>\n",g.children[g.childElementCount-1].click()}}(e,i),t.send("R*R1\n")},document.getElementById("stop_race_button").onclick=function(){t.send("R*R0\n")},function e(){const t=document.getElementById("voices");var n=speechSynthesis.getVoices();if(0!=n.length){n.forEach(e=>{const n=document.createElement("option");n.value=e.name,n.innerHTML=e.name,n.id=e.name,t.appendChild(n),e.name.includes("english")&&(t.value=e.name)});var l=localStorage.getItem("voice");null!=l&&(t.value=l),t.addEventListener("change",e=>{localStorage.setItem("voice",t.value)})}else setTimeout(()=>{e()})}(),document.getElementById("max_laps").value=i;var T={showPoint:!1,lineSmooth:!1,axisX:{type:Chartist.AutoScaleAxis,onlyInteger:!0,labelInterpolationFnc:function(e,t){return t%13==0?e/1e3:null}}},B=new Chartist.Line(".ct-chart",{},T);const L=document.getElementById("graph_div");L.addEventListener("wheel",(function(e){return r+=100*e.deltaY,r=Math.max(r,100),e.preventDefault(),!1}),!1),L.addEventListener("mousemove",(function(e){if(1==e.buttons){c=!1;var t=Math.min(Math.max(u-e.movementX*(r/1e3),0),s);t-r>0&&(u=t)}}),!1);setInterval((function(){c?(start=Math.max(0,s-r),end=void 0,u=s):(end=u,start=Math.max(0,end-r)),B.update({series:k(start,end)})}),100);