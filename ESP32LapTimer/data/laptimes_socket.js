var e=0,t=null,n=8,l=0,i=4,a=[],r=[[]],o=1e3,s=0,c=!0,u=0,d=0;const m=2;function v(e){e.style.outline="1px solid orange"}function f(e){e.style.outline="1px solid green"}function h(){t.send("ES*y"+String(d).padStart(4,"0")+"\n")}function p(e,t){return document.getElementById("lap_table_"+e).rows[t+1]}function g(e,t,n){return p(e,t).cells[n+m]}function _(e,t,n){return parseFloat(1*g(e,t,n).innerText)}function I(e,t){var n=p(e,t);return n.cells[n.cells.length-4]}function b(e,t){return parseFloat(1*I(e,t).innerText)}function x(e,t){var n=p(e,t);return n.cells[n.cells.length-2]}function y(e,t){var n=p(e,t);return n.cells[n.cells.length-1]}function E(e,t,n){var l=p(e,t);l.cells[l.cells.length-3].innerText=n}function C(e,t,a,r){if(!(a>=i)){var o=function(e,t){return parseFloat(y(e,t).innerText)}(e,t),s=0;if(r/=1e3,0!=l||0!=a){if(o=Math.min(o,r),0==_(e,t,a))!function(e,t,n){var l=new SpeechSynthesisUtterance;const i=document.getElementById("voices");l.lang="en",l.text=`${e} lap ${t} is ${n} seconds`,console.log(l.voice),l.voice=speechSynthesis.getVoices().filter((function(e){return e.name===i.value}))[0],speechSynthesis.speak(l)}(function(e,t){return p(e,t).cells[1].lastChild.value}(e,t),a+l,r.toFixed(2)),function(e,t,n){I(e,t).innerText=n}(e,t,(b(e,t)+r).toFixed(3)),function(e){for(var t=[],l=0;l<n;++l){var i=b(e,l);i>0&&(t[t.length]={num:l,time:i})}for(t.sort((function(e,t){return e.time-t.time})),l=0;l<t.length;++l){E(e,t[l].num,l+1)}}(e);if(o.toFixed(3)==r.toFixed(3)){for(var c=g(e,t,a),u=0;u<i;++u)g(e,t,u).classList.remove("best_lap");c.classList.add("best_lap")}}!function(e,t,n,l){p(e,t).cells[n+m].innerText=l}(e,t,a,r);s=0;for(u=0==l;u<i;++u){var d=_(e,t,u);if(0==d||isNaN(d))break;s+=d}(function(e,t,n){x(e,t).innerText=n})(e,t,(s/=u-(0==l)).toFixed(3)),function(e,t,n){y(e,t).innerText=n}(e,t,o.toFixed(3))}}function k(t){var n="E"==t[0];n&&(t=t.substr(1));var l=parseInt(t[1]),i=t[2];if(n)switch(i){case"R":e=parseInt(t.substr(3),16);break;case"y":var o=parseInt(t.substr(3,8),16),c=parseInt(t.substr(11,4),16);null==r[l]&&(r[l]=[]),r[l].push({time:o,rssi:c}),s=Math.max(s,o)}else switch(i){case"L":var u=parseInt(t.substr(3,2),16),d=parseInt(t.substr(5),16);C(e,l,u,d);break;case"A":a[l]="1"==t[3];var m=p(e,l).cells[0].lastChild;f(m),m.checked=a[l];break;case"R":document.getElementById("race_mode").innerHTML=parseInt(t[3])?"Racing":"Finished"}}function B(e){for(var t=e.data.split("\n"),n=0;n<t.length;++n)k(t[n])}function T(e,t){var l=[];null==e&&(e=0);for(var i=0;i<n;++i)if(a[i]&&null!=r[i]){var o=l.length;l[o]={name:"Pilot"+i,data:[]};for(var s=r[i].length-1;s>=0;--s){var c=r[i][s].rssi,u=r[i][s].time;if(null==t&&(t=u),u<e)break;u>t||l[o].data.push({x:u,y:c})}l[o].data.reverse()}return l}!function e(n){(t=new WebSocket(n)).onmessage=B,t.onclose=function(){setTimeout((function(){e(n)}),1e3)},t.onopen=function(){t.send("ER*a\n"),t.send("R*a\n"),h()}}("ws://192.168.4.1/ws"),document.getElementById("start_race_button").onclick=function(){e+=1,i=parseInt(document.getElementById("max_laps").value),function(e,i){if(console.log("Building table with race_num "+e),null==(r=document.getElementById("lap_table_"+e))){var r,o;for((r=document.getElementById("lap_table_default").cloneNode(!0)).id="lap_table_"+e,o=i;0!=o;o--){(s=r.rows[0].insertCell(m)).outerHTML='<th align="center">Lap '+(o-(0==l))+"</th>"}for(o=0;o<n;o++){var s,c=r.insertRow(-1);(s=c.insertCell(-1)).innerHTML='<input id="pilot_active_box_'+o+'" value='+o+' type="checkbox"></input>',s.firstChild.onclick=function(){v(this),a[parseInt(this.value)]=void 0,t.send(`R${this.value}A${this.checked?1:0}\n`)},s.firstChild.checked=a[o],f(s.firstChild),null==a[o]&&v(s.firstChild),s=c.insertCell(-1);var u=localStorage.getItem("pilot_name_"+o);null==u&&(u="Pilot "+(o+1)),s.innerHTML='<input id="pilot_name_'+o+'" type="text" name="pilot" value="'+u+'" oninput=update_default_pilot_name('+o+")>";for(var d=0;d<i;++d)c.insertCell(-1);c.insertCell(-1),c.insertCell(-1),c.insertCell(-1),c.insertCell(-1).innerText="99999"}var h=document.getElementById("table_container"),p=document.createElement("div");p.setAttribute("class","tabcontent"),p.id="round_tab_content_"+e,h.appendChild(p),p.appendChild(r);var g=document.getElementById("round_buttons");console.log(g),g.innerHTML+="<button class='tablinks' onclick='openRound(event,"+e+")'>Round "+e+"</button>\n",g.children[g.childElementCount-1].click()}}(e,i),t.send("R*R1\n")},document.getElementById("stop_race_button").onclick=function(){t.send("R*R0\n")},d=parseInt(localStorage.getItem("rssi_interval")),isNaN(d)&&(d=0),document.getElementById("rssi_interval").value=d,document.getElementById("rssi_interval").addEventListener("input",(function(){d=parseInt(document.getElementById("rssi_interval").value),localStorage.setItem("rssi_interval",d),h()})),function e(){const t=document.getElementById("voices");var n=speechSynthesis.getVoices();if(0!=n.length){n.forEach(e=>{const n=document.createElement("option");n.value=e.name,n.innerHTML=e.name,n.id=e.name,t.appendChild(n),e.name.includes("english")&&(t.value=e.name)});var l=localStorage.getItem("voice");null!=l&&(t.value=l),t.addEventListener("change",e=>{localStorage.setItem("voice",t.value)})}else setTimeout(()=>{e()})}(),document.getElementById("max_laps").value=i;var S={low:800,high:3e3,showPoint:!1,lineSmooth:!1,axisX:{type:Chartist.AutoScaleAxis,onlyInteger:!0,labelInterpolationFnc:function(e,t){return t%13==0?e/1e3:null}}},L=new Chartist.Line(".ct-chart",{},S);const w=document.getElementById("graph_div");w.addEventListener("wheel",(function(e){return o+=100*e.deltaY,o=Math.max(o,100),e.preventDefault(),!1}),!1),w.addEventListener("mousemove",(function(e){if(1==e.buttons){c=!1;var t=Math.min(Math.max(u-e.movementX*(o/1e3),0),s);t-o>0&&(u=t),u==s&&(c=!0)}}),!1);setInterval((function(){c?(start=Math.max(0,s-o),end=void 0,u=s):(end=u,start=Math.max(0,end-o)),L.update({series:T(start,end)})}),100);