import*as e from"./constants.js";var t=null;function n(e,n,i,o,s){t.send(`${e}R${n}${i}${o.toString(16).padStart(s/4,"0").toUpperCase()}\n`)}function i(t,i,o,s){n(e.EXTENDED_PREFIX,t,i,o,s)}function o(e,t,n){i("*",e,t,n)}function s(e,t,i,o){n("",e,t,i,o)}function a(){t.send("ER*a\n"),t.send("R*a\n")}function E(e){e.setAttribute("val_state","pending")}function l(e){e.setAttribute("val_state","received")}function c(n){if("B"==n[0]){switch(c=n[1]){case e.BINARY_RSSI:var i=n[2]<<24&65535|n[3]<<16&65535|n[4]<<8&65535|65535&n[5],o=(255&n[6])<<8|255&n[7];console.log("Got binary! with time "+i+" and rssi "+o+" message: "+n)}}else{var s="E"==n[0];s&&(n=n.substr(1));var E=parseInt(n[1]),c=n[2];if(s)switch(c){case e.EXTENDED_VOLTAGE_TYPE:(r=document.getElementById("ADCVBATmode")).value=parseInt(n[3],16),l(r);break;case e.EXTENDED_VOLTAGE_CALIB:(r=document.getElementById("ADCcalibValue")).value=parseInt(n.substr(3),16)/1e3,l(r);break;case e.EXTENDED_EEPROM_RESET:l(r=document.getElementById("eepromReset")),a();break;case e.EXTENDED_DISPLAY_TIMEOUT:(r=document.getElementById("displayTimeout")).value=parseInt(n.substr(3),16),l(r);break;case e.EXTENDED_WIFI_CHANNEL:(r=document.getElementById("WiFiChannel")).value=parseInt(n[3],16),l(r);break;case e.EXTENDED_WIFI_PROTOCOL:(r=document.getElementById("WiFiProtocol")).value=parseInt(n[3],16),l(r);break;case e.EXTENDED_FILTER_CUTOFF:(r=document.getElementById("RXFilterCutoff")).value=parseInt(n.substr(3),16),l(r);break;case e.EXTENDED_NUM_MODULES:(r=document.getElementById("NumRXs")).value=parseInt(n[3],16),l(r);break;case e.EXTENDED_MULTIPLEX_OFF:(r=document.getElementById("pilot_multuplex_off_"+E)).checked=1==parseInt(n[3]),l(r);break;case e.EXTENDED_CALIB_MIN:(r=document.getElementById("calib_table")).rows[E+1].cells[1].innerText=parseInt(n.substr(3),16);break;case e.EXTENDED_CALIB_MAX:(r=document.getElementById("calib_table")).rows[E+1].cells[2].innerText=parseInt(n.substr(3),16);break;case e.EXTENDED_CALIB_STATUS:l(r=document.getElementById("calibrate_button"));for(var u=0;u<6;++u)t.send(`ER${u}${e.EXTENDED_CALIB_MIN}\n`),t.send(`ER${u}${e.EXTENDED_CALIB_MAX}\n`);break;case e.EXTENDED_DEBUG_FREE_HEAP:document.getElementById("heap_free").innerText=(parseInt(n.substr(3),16)/1024).toFixed(2);break;case e.EXTENDED_DEBUG_MIN_FREE_HEAP:document.getElementById("heap_low").innerText=(parseInt(n.substr(3),16)/1024).toFixed(2);break;case e.EXTENDED_DEBUG_MAX_BLOCK_HEAP:document.getElementById("heap_max_block").innerText=(parseInt(n.substr(3),16)/1024).toFixed(2)}else switch(c){case e.RESPONSE_VOLTAGE:(r=document.getElementById("Var_VBAT")).innerText=(parseInt(n.substr(3),16)*(5/1024)*11).toFixed(2);break;case e.RESPONSE_THRESHOLD:(r=document.getElementById("RSSIthreshold"+E)).value=parseInt(n.substr(3),16),l(r);break;case e.RESPONSE_PILOT_ACTIVE:(r=document.getElementById("pilot_enabled_"+E)).checked=1==parseInt(n[3]),l(r);break;case e.RESPONSE_BAND:(r=document.getElementById("band"+E)).value=n[3],l(r);break;case e.RESPONSE_CHANNEL:var r;(r=document.getElementById("channel"+E)).value=n[3],l(r)}}}function u(e){console.log(e.data);for(var t=e.data.split("\n"),n=0;n<t.length;++n)c(t[n])}!function(){for(var t=0;t<8;++t){var n,o=document.getElementById("pilot_table").insertRow(-1);o.insertCell(-1).innerText=t+1;var a="";a=`<select class="band_select" name="band${t}" id="band${t}">`,a+='<option selected="" value="0">R</option><option value="1">A</option><option value="2">B</option><option value="3">E</option><option value="4">F</option><option value="5">D</option><option value="6">Connex</option><option value="7">Connex2</option></select>',(n=o.insertCell(-1)).innerHTML=a,n.lastChild.onclick=function(){E(this),s(parseInt(this.id.slice(-1)),e.CONTROL_BAND,parseInt(1*this.value),4)},a=`<select name="channel${t}" id="channel${t}" `,a+='class="channel_select"><option value="0">1</option><option value="1">2</option><option value="2">3</option><option value="3">4</option><option value="4">5</option><option value="5">6</option><option value="6">7</option><option value="7">8</option></select>',(n=o.insertCell(-1)).innerHTML=a,n.lastChild.onclick=function(){E(this),s(parseInt(this.id.slice(-1)),e.CONTROL_CHANNEL,parseInt(1*this.value),4)},a=`<input type="number" id="RSSIthreshold${t}" min="0" max="342" step="1" class="rssi_select">`,(n=o.insertCell(-1)).innerHTML=a,n.lastChild.onclick=function(){E(this),s(parseInt(this.id.slice(-1)),e.CONTROL_THRESHOLD,parseInt(1*this.value),16)},a=`<input type="checkbox" id="pilot_enabled_${t}">`,(n=o.insertCell(-1)).innerHTML=a,n.lastChild.onclick=function(){E(this),s(parseInt(this.id.slice(-1)),e.CONTROL_PILOT_ACTIVE,this.checked?1:0,4)},a=`<input type="checkbox" id="pilot_multuplex_off_${t}">`,(n=o.insertCell(-1)).innerHTML=a,n.lastChild.onclick=function(){E(this),i(parseInt(this.id.slice(-1)),e.EXTENDED_MULTIPLEX_OFF,this.checked?1:0,4)}}}(),function e(n){(t=new WebSocket(n)).onmessage=u,t.onclose=function(){setTimeout((function(){e(n)}),5e3)},t.onopen=function(){a()}}("ws://192.168.4.1/ws"),document.getElementById("ADCVBATmode").oninput=function(){E(this),t.send(`ER*${e.EXTENDED_VOLTAGE_TYPE}${this.value}\n`)},document.getElementById("ADCcalibValue").oninput=function(){(E(this),this.value.endsWith("."))?this.setAttribute("val_state","error"):o(e.EXTENDED_VOLTAGE_CALIB,parseInt(1e3*this.value),16)},document.getElementById("eepromReset").onclick=function(){E(this),t.send(`ER*${e.EXTENDED_EEPROM_RESET}\n`)},document.getElementById("displayTimeout").oninput=function(){E(this),o(e.EXTENDED_DISPLAY_TIMEOUT,parseInt(1*this.value),16)},document.getElementById("WiFiProtocol").oninput=function(){E(this),o(e.EXTENDED_WIFI_PROTOCOL,parseInt(this.value),4)},document.getElementById("WiFiChannel").oninput=function(){E(this),o(e.EXTENDED_WIFI_CHANNEL,parseInt(this.value),4)},document.getElementById("RXFilterCutoff").oninput=function(){E(this),o(e.EXTENDED_FILTER_CUTOFF,parseInt(1*this.value),16)},document.getElementById("NumRXs").oninput=function(){E(this),o(e.EXTENDED_NUM_MODULES,parseInt(1*this.value),4)},document.getElementById("calibrate_button").onclick=function(){E(this),t.send(`ER*${e.EXTENDED_CALIB_START}\n`)},setInterval((function(){t.send("R*v\n"),t.send("ER*h\n"),t.send("ER*H\n"),t.send("ER*B\n")}),2e3);